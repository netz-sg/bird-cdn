version: '3.9'

services:
  # NGINX CDN Edge (Cache Layer)
  nginx-cdn:
    image: nginx:1.25-alpine
    container_name: cdn-edge
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/cache:/var/cache/nginx
      - ./ssl:/etc/nginx/ssl:ro
      - ./certbot/www:/var/www/certbot:ro  # Certbot ACME Challenge
      - ./certbot/conf:/etc/letsencrypt:ro  # Let's Encrypt Certs
    depends_on:
      - origin-storage
      - backend-api
    networks:
      - cdn-network
    restart: unless-stopped

  # Certbot für Let's Encrypt SSL
  certbot:
    image: certbot/certbot:latest
    container_name: cdn-certbot
    profiles:
      - ssl  # Nur starten mit: docker-compose --profile ssl up -d
    volumes:
      - ./certbot/www:/var/www/certbot:rw
      - ./certbot/conf:/etc/letsencrypt:rw
      - ./certbot/logs:/var/log/letsencrypt:rw
      - ./certbot/init.sh:/docker-entrypoint.sh:ro
      - ./nginx/conf.d/cdn-ssl.conf.template:/tmp/cdn-ssl.conf.template:ro
    environment:
      - CERTBOT_DOMAIN=${CDN_DOMAIN}
      - CERTBOT_EMAIL=${LETSENCRYPT_EMAIL}
      - CERTBOT_STAGING=${LETSENCRYPT_STAGING:-false}
    entrypoint: /docker-entrypoint.sh
    depends_on:
      - nginx-cdn
    networks:
      - cdn-network
    restart: unless-stopped

  # Origin Storage (MinIO)
  origin-storage:
    image: minio/minio:latest
    container_name: cdn-origin
    ports:
      - "9010:9000"
      - "9011:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: adminpassword123
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9011
    volumes:
      - ./storage/data:/data
    command: server /data --console-address ":9001"
    networks:
      - cdn-network
    restart: unless-stopped

  # Backend API (FastAPI)
  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cdn-backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://cdn:cdn123@postgres:5432/cdn
      - MINIO_ENDPOINT=origin-storage:9000
      - MINIO_ACCESS_KEY=admin
      - MINIO_SECRET_KEY=adminpassword123
      - REDIS_URL=redis://redis:6379
      - NGINX_CACHE_PATH=/var/cache/nginx
      - CDN_DOMAIN=localhost
      - CDN_PROTOCOL=http
    volumes:
      - ./nginx/cache:/var/cache/nginx
      - ./backend:/app
    depends_on:
      - postgres
      - redis
    networks:
      - cdn-network
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: cdn-postgres
    environment:
      POSTGRES_DB: cdn
      POSTGRES_USER: cdn
      POSTGRES_PASSWORD: cdn123
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - cdn-network
    restart: unless-stopped

  # Redis (für Caching & Queue)
  redis:
    image: redis:7-alpine
    container_name: cdn-redis
    networks:
      - cdn-network
    restart: unless-stopped

  # Frontend (React Admin UI)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cdn-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend-api
    networks:
      - cdn-network
    restart: unless-stopped

  # Prometheus (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: cdn-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - cdn-network
    restart: unless-stopped

  # Grafana (Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: cdn-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - ./monitoring/grafana:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - cdn-network
    restart: unless-stopped

  # NGINX Prometheus Exporter
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: cdn-nginx-exporter
    ports:
      - "9113:9113"
    command:
      - '-nginx.scrape-uri=http://nginx-cdn:8080/stub_status'
    depends_on:
      - nginx-cdn
    networks:
      - cdn-network
    restart: unless-stopped

networks:
  cdn-network:
    driver: bridge

volumes:
  postgres-data:
  prometheus-data:
  grafana-data:
